{% load static %}

<section class="max-w-4xl mx-auto px-6 md:px-8 py-10">
  <!-- Reviews container -->
  <div class="bg-white rounded-2xl shadow border border-black/10 p-8">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-semibold text-gray-800">
        Reviews ({{ c.reviews.count }})
      </h2>

      <!-- Checkout Button (Members only) -->
      {% if user.is_authenticated and user.role == "member" %}
        <a href="{% url 'checkout:checkout' class_id=c.id %}"
          class="inline-block px-6 py-2.5 rounded-2xl bg-[#f07a3b] text-white font-semibold shadow-sm hover:brightness-110">
            Checkout
        </a>
      {% endif %}
    </div>

    <!-- Average Rating -->
    <div class="flex items-center gap-2 mb-6">
      <div class="flex text-yellow-500 text-lg">
        {% for i in "123"|make_list %}
          {% if i|add:0 <= c.average_rating %}
            <span>★</span>
          {% else %}
            <span>☆</span>
          {% endif %}
        {% endfor %}
      </div>
      <span class="font-medium">{{ c.average_rating|default:"0.0" }}</span>
      <span class="text-sm text-gray-500">/ 3</span>
    </div>

    <!-- Add Review Button (Members only) -->
    {% if user.is_authenticated and user.role == "member" %}
      <button id="addReviewBtn"
        class="inline-block px-6 py-2.5 rounded-2xl bg-[#4C4974] text-white font-semibold shadow-sm hover:brightness-110">
        Add / Update Your Review
      </button>
    {% elif user.is_authenticated %}
      <p class="text-sm text-gray-500">Only members can add reviews.</p>
    {% else %}
      <p class="text-sm text-gray-500">Login to add a review.</p>
    {% endif %}

    <!-- Reviews List -->
    <div id="reviewsContainer" class="mt-8 space-y-4">
      {% include "_reviews_list.html" with c=c %}
    </div>

  </div>
</section>

<!-- Modal (Add/Edit Review) -->
<div id="reviewModal"
     class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white rounded-2xl p-6 w-96 shadow-lg border border-black/10">
    <h3 id="modalTitle" class="text-lg font-semibold mb-3">Add Review</h3>
    <form id="reviewForm" data-class-id="{{ c.id }}">
      {% csrf_token %}
      <input type="hidden" name="review_id" id="review_id">

      <!-- Star Rating -->
      <label class="block text-sm font-medium mb-1">Rating:</label>
      <div id="starRating" class="flex gap-1 mb-3 cursor-pointer text-2xl text-yellow-500">
        <span data-value="1" class="star">☆</span>
        <span data-value="2" class="star">☆</span>
        <span data-value="3" class="star">☆</span>
      </div>
      <input type="hidden" name="rating" id="rating" required>

      <!-- Comment -->
      <label for="comment" class="block text-sm font-medium mb-1">Comment:</label>
      <textarea name="comment" id="comment" rows="3"
                class="border rounded-lg w-full p-2 mb-4"></textarea>

      <div class="flex justify-end gap-2">
        <button type="button" id="closeModalBtn"
                class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
          Cancel
        </button>
        <button type="submit"
                class="inline-block px-6 py-2.5 rounded-2xl bg-[#4C4974] text-white font-semibold shadow-sm hover:brightness-110">
          Submit
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Inline JS -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const openBtn = document.getElementById("addReviewBtn");
  const modal = document.getElementById("reviewModal");
  const closeBtn = document.getElementById("closeModalBtn");
  const stars = document.querySelectorAll("#starRating .star");
  const ratingInput = document.getElementById("rating");
  const form = document.getElementById("reviewForm");
  const reviewsContainer = document.getElementById("reviewsContainer");

  //  handle star clicks
  stars.forEach(star => {
    star.addEventListener("click", () => {
      const value = parseInt(star.dataset.value);
      ratingInput.value = value;
      stars.forEach(s => {
        s.textContent = s.dataset.value <= value ? "★" : "☆";
      });
    });
  });

  //  open/close modal
  openBtn?.addEventListener("click", () => modal.classList.remove("hidden"));
  closeBtn?.addEventListener("click", () => modal.classList.add("hidden"));
  window.addEventListener("click", e => { if (e.target === modal) modal.classList.add("hidden"); });

  //  submit form via AJAX
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const classId = form.dataset.classId;
    const formData = new FormData(form);

    const response = await fetch(`/classes/${classId}/add_review/`, {
      method: "POST",
      headers: { "X-Requested-With": "XMLHttpRequest" },
      body: formData
    });

    if (response.ok) {
      const html = await response.text();
      reviewsContainer.innerHTML = html;
      modal.classList.add("hidden");
      form.reset();
      stars.forEach(s => s.textContent = "☆");
    } else {
      alert("Error saving review!");
    }
  });

  //  handle delete review
  reviewsContainer.addEventListener("click", async (e) => {
    if (e.target.classList.contains("deleteReviewBtn")) {
      const reviewId = e.target.dataset.id;
      const classId = form.dataset.classId;

      if (!confirm("Are you sure you want to delete this review?")) return;

      const response = await fetch(`/classes/${classId}/delete_review/${reviewId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
          "X-Requested-With": "XMLHttpRequest",
        },
      });

      if (response.ok) {
        const html = await response.text();
        reviewsContainer.innerHTML = html;
      } else {
        alert("Error deleting review!");
      }
    }
  });
});
</script>
