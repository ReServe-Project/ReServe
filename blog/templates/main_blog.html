{% extends "base.html" %}
{% load static %}
{% block title %}Blogs{% endblock title %}

{% block content %}
<div class="min-h-screen bg-[#F7F4EC] py-10">

    <div class="mt-0 relative left-1/2 right-1/2 -ml-[50vw] -mr-[50vw] w-screen">
        <img
            src="{% static 'images/blog_header.png' %}"
            alt="Blog header"
            class="mt-0 w-screen object-cover"
        />
        <div class="mt-10 absolute top-20 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center">
            <header class="max-w-3xl mx-auto text-center px-4">
                <h1 class="font-head font-extrabold md:text-5xl text-[#434162]">
                    Share Your <span class="text-[#F1642E]">Blogs</span> With Us!
                </h1>
                <p class="font-sub font-semibold mt-2 text-[#505050]">The Latest Buzz</p>
            </header>
        </div>
        {% if request.user.is_authenticated %}
            <button type="button"
                    class="font-sub openCreateBtn hidden md:inline-flex absolute left-1/2 -translate-x-1/2 top-[70%] items-center justify-center px-6 py-3 rounded-lg bg-[#504E76] text-white text-sm shadow-lg hover:bg-[#35344F]">
                + Create Now!
            </button>
        {% else %}
            <a href="{% url 'login' %}"
                class="font-sub hidden md:inline-flex absolute left-1/2 -translate-x-1/2 top-[70%] items-center justify-center px-6 py-3 rounded-lg bg-[#504E76] text-white text-sm shadow-lg hover:bg-[#35344F]">
                + Create Now!
            </a>
        {% endif %}
    </div>

    <div class="md:hidden flex justify-center mt-6">
        {% if request.user.is_authenticated %}
            <button type="button"
                    class="openCreateBtn inline-flex items-center justify-center px-5 py-2 rounded-full bg-[#504E76] text-white text-sm shadow hover:bg-[#35344F]">
                + Create Now!
            </button>
        {% else %}
            <a href="{% url 'login' %}"
                class="inline-flex items-center justify-center px-5 py-2 rounded-full bg-[#504E76] text-white text-sm shadow hover:bg-[#35344F]">
                + Create Now!
            </a>
        {% endif %}
    </div>
    <!-- Add at the top of your blog list section -->
    <div class="flex items-center justify-center my-0">
      <div class="bg-white rounded-full shadow flex items-center px-4 py-2 space-x-4" style="box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
        <a href="?filter=all"
           class="px-8 py-3 rounded-full font-semibold transition
                  {% if filter_type == 'all' %}
                    bg-[#A34B23] text-white border-2 border-[#A34B23]
                  {% else %}
                    bg-[#F7F4EC] text-[#6B4F2A] border-2 border-[#A34B23]
                  {% endif %}">
          All Blogs
        </a>
        <span class="h-8 w-px bg-[#434162]"></span>
        <a href="?filter=my"
           class="px-8 py-3 rounded-full font-semibold transition
                  {% if filter_type == 'my' %}
                    bg-[#A34B23] text-white border-2 border-[#A34B23]
                  {% else %}
                    bg-[#F7F4EC] text-[#6B4F2A] border-2 border-[#A34B23]
                  {% endif %}">
          My Blogs
        </a>
      </div>
    </div>
    {% if not blog_list %}
        <p class="text-center text-slate-500 mt-16">No data available in Blog.</p>
    {% else %}
    <section class="mt-10 max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8 px-4">
        {% for blog in blog_list %}
        <article class="relative bg-white rounded-[28px] shadow-lg ring-1 ring-black/5 p-4 md:p-6">
            <div class="relative">
                {% if blog.thumbnail %}
                    <img src="{{ blog.thumbnail }}" alt="thumbnail"
                        class="h-56 w-full object-cover rounded-[22px]">
                {% else %}
                    <div class="h-56 w-full rounded-[22px] bg-slate-200"></div>
                {% endif %}

                {# top-left action pills for the owner #}
                <div class="absolute top-3 left-3 z-10 flex gap-3">
                    {% if request.user.is_authenticated and request.user.id == blog.user.id %}
                        <button
                            type="button"
                            class="openEditBtn bg-blue-600 px-4 py-2 rounded-xl text-white"
                            data-blog-id="{{ blog.pk }}"
                            data-blog-title="{{ blog.title }}"
                            data-blog-thumbnail="{{ blog.thumbnail|default_if_none:'' }}"
                            data-blog-content="{{ blog.content|escapejs }}"
                        >
                            Edit
                        </button>
                        <button type="button" class="openDeleteBtn bg-red-600 px-4 py-2 rounded-xl text-white" data-blog-id="{{ blog.pk }}" data-blog-title="{{ blog.title }}">
                            Delete
                        </button>
                    {% endif %}
                </div>
                <a aria-label="Read {{ blog.title }}" href="{% url 'blog:blog_details' blog.id %}"
                    class="absolute -bottom-6 right-3 inline-flex h-16 w-16 items-center justify-center
                            rounded-full bg-[#434162] text-white shadow-xl ring-4 ring-white
                            hover:bg-[#353357]">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-7 w-7 fill-current">
                        <path d="M7 7a1 1 0 0 1 1-1h9a1 1 0 0 1 1 1v9a1 1 0 1 1-2 0V9.414l-9.293 9.293a1 1 0 0 1-1.414-1.414L14.586 8H8a1 1 0 0 1-1-1Z"/>
                    </svg>
                </a>
            </div>

            <h3 class="mt-5 font-head text-xl line-clamp-2 font-extrabold leading-tight text-[#793217]">
                <a href="{% url 'blog:blog_details' blog.id %}">{{ blog.title }}</a>
            </h3>
            <p class="mt-2 text-slate-600">
                {{ blog.content|truncatewords:22 }}
            </p>
        </article>
        {% endfor %}
        
        <div id="editModal" class="fixed inset-0 z-[101] hidden" aria-hidden="true">
            <div id="editModalBackdrop" class="absolute inset-0 bg-black/50"></div>
            <div class="absolute inset-0 flex items-center justify-center p-4">
                <div class="w-full max-w-lg rounded-[28px] bg-[#F7F4EC] shadow-xl ring-1 ring-black/10 p-6 md:p-8">
                    <div class="text-center mb-4">
                        <h2 class="font-head text-3xl font-extrabold text-slate-800">Edit Blog</h2>
                    </div>
                    <form id="editBlogForm" method="POST" action="" class="space-y-5">
                        {% csrf_token %}
                        <input type="hidden" name="blog_id" id="editBlogId">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700">Title</label>
                            <input type="text" name="title" id="editBlogTitle" required
                                    class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-slate-800">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700">Thumbnail</label>
                            <input type="url" name="thumbnail" id="editBlogThumbnail" placeholder="Link"
                                    class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-slate-800">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700">Content</label>
                            <textarea name="content" id="editBlogContent" rows="6" placeholder="Enter content"
                                        class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-slate-800"></textarea>
                        </div>
                        <div>
                            <p id="editFormErrors" class="hidden text-sm text-red-600"></p>
                        </div>
                        <div class="mt-6 flex items-center justify-between gap-4">
                            <button type="button" id="cancelEditBtn"
                                    class="w-40 rounded-xl border border-orange-300 bg-orange-50 px-5 py-3 font-semibold text-orange-700 hover:bg-orange-100">
                                Cancel
                            </button>
                            <button type="submit"
                                    class="w-44 rounded-xl bg-orange-500 px-5 py-3 font-semibold text-white hover:bg-orange-600">
                                Save
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div id="deleteModal" class="fixed inset-0 z-[102] hidden" aria-hidden="true">
            <div id="deleteModalBackdrop" class="absolute inset-0 bg-black/50"></div>
            <div class="absolute inset-0 flex items-center justify-center p-4">
                <div class="w-full max-w-md rounded-[28px] bg-[#F7F4EC] shadow-xl ring-1 ring-black/10 p-6 md:p-8">
                    <div class="text-center mb-4">
                        <h2 class="font-head text-2xl font-extrabold text-slate-800">Delete Blog</h2>
                        <p id="deleteBlogTitle" class="mt-2 text-slate-700"></p>
                    </div>
                    <form id="deleteBlogForm" method="POST" action="" class="space-y-5">
                        {% csrf_token %}
                        <input type="hidden" name="blog_id" id="deleteBlogId">
                        <div class="mt-6 flex items-center justify-between gap-4">
                            <button type="button" id="cancelDeleteBtn"
                                    class="w-40 rounded-xl border border-orange-300 bg-orange-50 px-5 py-3 font-semibold text-orange-700 hover:bg-orange-100">
                                Cancel
                            </button>
                            <button type="submit"
                                    class="w-44 rounded-xl bg-red-500 px-5 py-3 font-semibold text-white hover:bg-red-600">
                                Delete
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>
    {% endif %}
</div>

<div id="createModal" class="fixed inset-0 z-[100] hidden" aria-hidden="true">
    <div id="modalBackdrop" class="absolute inset-0 bg-black/50"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="w-full max-w-lg rounded-[28px] bg-[#F7F4EC] shadow-xl ring-1 ring-black/10 p-6 md:p-8">
            <div class="text-center mb-4">
                <h2 class="font-head text-3xl font-extrabold text-slate-800">Create Blog</h2>
            </div>

            <form id="createBlogForm" method="POST" action="{% url 'blog:create_blog' %}" class="space-y-5">
                {% csrf_token %}

                <div>
                    <label class="block text-sm font-semibold text-slate-700">Title</label>
                    <input type="text" name="title" placeholder="Enter title" required
                            class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-slate-800 placeholder-slate-400 outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700">Thumbnail</label>
                    <input type="url" name="thumbnail" placeholder="Link"
                            class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-slate-800 placeholder-slate-400 outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700">Content</label>
                    <textarea name="content" rows="6" placeholder="Enter content"
                                class="mt-1 w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-slate-800 placeholder-slate-400 outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>

                <p id="formErrors" class="hidden text-sm text-red-600"></p>

                <div class="mt-6 flex items-center justify-between gap-4">
                    <button type="button" id="cancelCreateBtn"
                            class="w-40 rounded-xl border border-orange-300 bg-orange-50 px-5 py-3 font-semibold text-orange-700 hover:bg-orange-100">
                        Cancel
                    </button>
                    <button type="submit"
                            class="w-44 rounded-xl bg-orange-500 px-5 py-3 font-semibold text-white hover:bg-orange-600">
                        Create
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('createModal');
    const backdrop = document.getElementById('modalBackdrop');
    const openBtns = Array.from(document.querySelectorAll('.openCreateBtn'));
    const cancelBtn = document.getElementById('cancelCreateBtn');
    const form = document.getElementById('createBlogForm');
    const errorBox = document.getElementById('formErrors');

    const editModal = document.getElementById('editModal');
    const editBackdrop = document.getElementById('editModalBackdrop');
    const openEditBtns = Array.from(document.querySelectorAll('.openEditBtn'));
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const editForm = document.getElementById('editBlogForm');
    const editBlogId = document.getElementById('editBlogId');
    const editBlogTitle = document.getElementById('editBlogTitle');
    const editBlogThumbnail = document.getElementById('editBlogThumbnail');
    const editBlogContent = document.getElementById('editBlogContent');
    const editErrorBox = document.getElementById('editFormErrors');

    const deleteModal = document.getElementById('deleteModal');
    const deleteBackdrop = document.getElementById('deleteModalBackdrop');
    const openDeleteBtns = Array.from(document.querySelectorAll('.openDeleteBtn'));
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const deleteForm = document.getElementById('deleteBlogForm');
    const deleteBlogId = document.getElementById('deleteBlogId');
    const deleteBlogTitle = document.getElementById('deleteBlogTitle');
    const deleteErrorBox = document.getElementById('deleteFormErrors');

    const closeModal = () => {
        modal?.classList.add('hidden');
        if (errorBox) { errorBox.classList.add('hidden'); errorBox.textContent = ''; }
    };

    const closeEditModal = () => {
        editModal?.classList.add('hidden');
        if (editErrorBox) { editErrorBox.classList.add('hidden'); editErrorBox.textContent = ''; }
    };

    const closeDeleteModal = () => {
        deleteModal?.classList.add('hidden');
        if (deleteErrorBox) { deleteErrorBox.classList.add('hidden'); deleteErrorBox.textContent = ''; }
    };

    if (modal) {
        const openModal = () => modal.classList.remove('hidden');

        openBtns.forEach(b => b.addEventListener('click', openModal));
        backdrop?.addEventListener('click', closeModal);
        cancelBtn?.addEventListener('click', closeModal);

        form?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = form.getAttribute('action');
            const formData = new FormData(form);

            try {
                const resp = await fetch(url, { method: 'POST', body: formData });
                if (resp.ok) { window.location.reload(); }
                else {
                    errorBox.textContent = 'Could not create blog. Please check your inputs.';
                    errorBox.classList.remove('hidden');
                }
            } catch {
                errorBox.textContent = 'Network error. Try again.';
                errorBox.classList.remove('hidden');
            }
        });
    }

    if (editModal) {
        const openEditModal = (btn) => {
            editBlogId.value = btn.dataset.blogId;
            editBlogTitle.value = btn.dataset.blogTitle || '';
            editBlogThumbnail.value = btn.dataset.blogThumbnail || '';
            editBlogContent.value = btn.dataset.blogContent || '';
            editForm.setAttribute('action', `/blog/edit/${btn.dataset.blogId}/`);
            editModal.classList.remove('hidden');
            if (editErrorBox) { editErrorBox.classList.add('hidden'); editErrorBox.textContent = ''; }
        };

        openEditBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                openEditModal(btn);
            });
        });
        editBackdrop?.addEventListener('click', closeEditModal);
        cancelEditBtn?.addEventListener('click', closeEditModal);

        editForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = editForm.getAttribute('action');
            const formData = new FormData(editForm);

            try {
                const resp = await fetch(url, { method: 'POST', body: formData });
                if (resp.ok) {
                    window.location.reload();
                } else {
                    if (editErrorBox) {
                        editErrorBox.textContent = 'Could not update blog. Please check your inputs.';
                        editErrorBox.classList.remove('hidden');
                    }
                }
            } catch {
                if (editErrorBox) {
                    editErrorBox.textContent = 'Network error. Try again.';
                    editErrorBox.classList.remove('hidden');
                }
            }
        });
    }

    if (deleteModal) {
        const openDeleteModal = (btn) => {
            deleteBlogId.value = btn.dataset.blogId;
            deleteBlogTitle.textContent = `Are you sure you want to delete this blog?`;
            deleteForm.setAttribute('action', `/blog/delete/${btn.dataset.blogId}/`);
            deleteModal.classList.remove('hidden');
            if (deleteErrorBox) { deleteErrorBox.classList.add('hidden'); deleteErrorBox.textContent = ''; }
        };

        openDeleteBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                openDeleteModal(btn);
            });
        });
        deleteBackdrop?.addEventListener('click', closeDeleteModal);
        cancelDeleteBtn?.addEventListener('click', closeDeleteModal);

        deleteForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = deleteForm.getAttribute('action');
            const formData = new FormData(deleteForm);

            try {
                const resp = await fetch(url, { method: 'POST', body: formData });
                if (resp.ok) {
                    window.location.reload();
                } else {
                    if (deleteErrorBox) {
                        deleteErrorBox.textContent = 'Could not delete blog. Please try again.';
                        deleteErrorBox.classList.remove('hidden');
                    }
                }
            } catch {
                if (deleteErrorBox) {
                    deleteErrorBox.textContent = 'Network error. Try again.';
                    deleteErrorBox.classList.remove('hidden');
                }
            }
        });
    }
});
</script>
{% endblock scripts %}