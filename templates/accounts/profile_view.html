{% extends "base.html" %}
{% load static %}

{% block meta %}
<title>My Profile • ReServe</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'accounts/css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="profile-bg" style="background-image: url('{% static 'accounts/img/gym-bg.jpg' %}');">
  <div class="profile-container">
    <!-- Profile Card -->
    <section class="profile-card">
      <div class="card-head">
        <div class="avatar-wrap">
          <!-- solid fallback via onerror; src can be blank safely -->
          <img
            id="avatar-img"
            src="{{ user.avatar.url|default_if_none:'' }}"
            onerror="this.onerror=null;this.src='{% static 'accounts/img/avatar-placeholder.png' %}'"
            alt="Avatar"
          >
          <form id="avatarForm" action="{% url 'profile_avatar_update' %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <label class="avatar-btn">
              Change
              <input type="file" name="avatar" id="avatar-file" accept="image/*" hidden>
            </label>
          </form>
        </div>

        <div class="identity">
          <div class="reserve-badge">{{ user.reserve_id }}</div>
          <h1 class="display-name">{{ user.display_name|default:user.username }}</h1>
          <div class="meta-row">
            {% if user.get_role_display %}<span class="chip">{{ user.get_role_display }}</span>{% endif %}
            {% if user.handle %}<span class="handle">@{{ user.handle }}</span>{% endif %}
          </div>
        </div>
      </div>

      <div class="metrics">
        <div class="metric">
          <div class="label">WEIGHT</div>
          <div class="value" data-field="weight">
            {% if user.weight_kg %}{{ user.weight_kg }}<span class="unit"> kg</span>{% else %}—{% endif %}
          </div>
        </div>
        <div class="metric">
          <div class="label">HEIGHT</div>
          <div class="value" data-field="height">
            {% if user.height_cm %}{{ user.height_cm }}<span class="unit"> cm</span>{% else %}—{% endif %}
          </div>
        </div>
        <div class="metric">
          <div class="label">ROLE</div>
          <div class="value">{{ user.get_role_display|default:"—" }}</div>
        </div>
      </div>

      <div class="card-foot">
        <div class="last-login">Last Login: {{ user.last_login|date:"d/m/Y H:i" }}</div>
        <button class="btn-primary" data-open="edit">Edit Profile</button>
      </div>
    </section>
  </div>
</div>

<!-- Edit Modal -->
<div id="edit-modal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="edit-title">
    <div class="modal-head">
      <h2 id="edit-title">Edit Profile</h2>
      <button class="x-close" id="close-edit" aria-label="Close">✕</button>
    </div>

    <form id="editForm" action="{% url 'profile_update_ajax' %}" method="post" class="edit-grid" novalidate>
      {% csrf_token %}
      <div class="field span-2">
        <label for="id_display_name">Username</label>
        <input id="id_display_name" name="display_name" type="text" value="{{ user.display_name|default:user.username }}" placeholder="Username">
      </div>

      <div class="field">
        <label for="id_weight_kg">Weight</label>
        <input id="id_weight_kg" name="weight_kg" type="number" step="0.01" min="25" max="300" value="{{ user.weight_kg|default_if_none:'' }}" placeholder="Ex: 60 kg">
      </div>

      <div class="field">
        <label for="id_height_cm">Height</label>
        <input id="id_height_cm" name="height_cm" type="number" min="80" max="250" value="{{ user.height_cm|default_if_none:'' }}" placeholder="Ex: 160 cm">
      </div>

      <div class="modal-actions span-2">
        <button type="button" class="btn-ghost" id="cancel-edit">Cancel</button>
        <button type="submit" class="btn-primary">Update Changes</button>
      </div>

      <div class="form-errors span-2" id="edit-errors" aria-live="polite"></div>
    </form>
  </div>
</div>

<!-- JS -->
<script src="{% static 'accounts/js/profile.js' %}?v=20251024"></script>
<div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>
{% endblock %}
