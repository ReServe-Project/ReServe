{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container py-4" style="max-width: 800px;">
  <h3 class="mb-3 text-center">{{ class_details.class_name }}</h3>

  <!-- Class Information -->
  <div class="card shadow-sm p-4 mb-4">
    <div class="mb-3">
      <label class="form-label"><strong>Category</strong></label>
      <p>{{ class_details.get_category_display }}</p>
    </div>

    <div class="mb-3">
      <label class="form-label"><strong>Instructor</strong></label>
      <p>{{ class_details.instructor.display_name }}</p>
    </div>

    <div class="mb-3">
      <label class="form-label"><strong>Schedule</strong></label>
      <p>{{ class_details.get_schedule_display }}</p>
    </div>

    <div class="mb-3">
      <label class="form-label"><strong>Location</strong></label>
      <p>{{ class_details.location }}</p>
    </div>

    <div class="mb-3">
      <label class="form-label"><strong>Price</strong></label>
      <p>${{ class_details.price }}</p>
    </div>
  </div>

  <!-- Description -->
  <div class="card shadow-sm p-4 mb-4">
    <h5 class="mb-3">Description</h5>
    <p>{{ class_details.description }}</p>
  </div>

  <!-- Reviews & Rating Section -->
  <div class="card shadow-sm p-4 mb-4">
    <!-- Rating Summary -->
    <div class="text-center mb-4 p-3 bg-light rounded">
      <h5>Class Rating</h5>
      <div class="mb-2">
        {% with avg_rating=class_details.average_rating %}
        {% for i in "123" %}
          {% if forloop.counter <= avg_rating %}
            ★
          {% else %}
            ☆
          {% endif %}
        {% endfor %}
        <strong>{{ class_details.average_rating }}/3</strong>
        {% endwith %}
      </div>
      <small class="text-muted">Based on {{ class_details.review_count }} reviews</small>
    </div>
    
    <!-- Add Review Form -->
    {% if can_review %}
    <div class="mb-4">
      <h6>Add Your Review</h6>
      <form method="post" action="{% url 'product_details:add_review' class_details.id %}">
        {% csrf_token %}
        <div class="mb-3">
          <label class="form-label">Rating (1-3 stars)</label>
          <select name="rating" class="form-select" required>
            <option value="">Select rating</option>
            <option value="1">1 Star</option>
            <option value="2">2 Stars</option>
            <option value="3">3 Stars</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Comment</label>
          <textarea name="comment" class="form-control" rows="4" placeholder="Share your experience with this class..."></textarea>
        </div>
        <button type="submit" class="btn btn-success">Submit Review</button>
      </form>
    </div>
    {% elif user_review %}
    <div class="mb-4">
      <h6>Your Review</h6>
      <div class="p-3 bg-light rounded">
        <strong>Your Rating:</strong> 
        {% for i in "123" %}
          {% if forloop.counter <= user_review.rating %}
            ★
          {% else %}
            ☆
          {% endif %}
        {% endfor %}
        <p class="mt-2">{{ user_review.comment }}</p>
        <small class="text-muted">Posted on: {{ user_review.created_at }}</small>
      </div>
    </div>
    {% elif not user.is_authenticated %}
    <p class="text-center"><a href="{% url 'login' %}?next={{ request.path }}">Login to write a review</a></p>
    {% endif %}
    
    <!-- Reviews List -->
    <div>
      <h6>All Reviews</h6>
      {% for review in reviews %}
      <div class="border rounded p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong>{{ review.user.display_name }}</strong>
          <span>
            {% for i in "123" %}
              {% if forloop.counter <= review.rating %}
                ★
              {% else %}
                ☆
              {% endif %}
            {% endfor %}
          </span>
        </div>
        <p class="mb-2">{{ review.comment }}</p>
        <small class="text-muted">{{ review.created_at }}</small>
      </div>
      {% empty %}
      <p class="text-center">No reviews yet. Be the first to review!</p>
      {% endfor %}
    </div>
  </div>

  <!-- Booking Section -->
  <div class="text-center">
    {% if user.is_authenticated %}
      <form method="post" action="{% url 'product_details:book_class' class_details.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary btn-lg">Book This Class</button>
      </form>
    {% else %}
      <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-secondary btn-lg">Login to Book</a>
    {% endif %}
  </div>
</div>
{% endblock %}